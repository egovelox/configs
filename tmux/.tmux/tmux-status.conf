########################################
# STATUS BAR
########################################
set -g status-position bottom

# position of window list
set -g status-justify left

set -g status-interval 5
set -g status-style "bg=#1d1f21,fg=#eceff4"
# Have a different background
# set -g status-style "bg=#4c566a,fg=#eceff4"

# Span status line on 2 lines
set -g status-format[0] '' 
set -g status-format[1] '' 
set -g status-right ''
set -g status-left ''

########################################
# FIRST LINE : STATUS LEFT AND RIGHT BARS
########################################
# Set session name
set -g status-right "#[fg=#bf616a,bg=default] #S:#I "

# Set status dynamic data
set -ag status-right "#[fg=#81a1c1,bg=default] ðŸ”‹#(pmset -g batt | tail -1 | awk '{print $3}' | tr -d ';') #[default]"
#set -ag status-right "#[fg=#81a1c1,bg=default]ðŸ‘‹#($HOME/bin/slack_tracker/slack_tracker.sh -c) #[default]"
set -ag status-right "#[fg=#A9B53F,bg=default] #($HOME/.tmux/plugins/tmux-plugin-sysstat/scripts/mem.sh) | #($HOME/.tmux/plugins/tmux-plugin-sysstat/scripts/loadavg.sh) #[default]"

# Set time
set -ag status-right "#[fg=#bf616a,bg=default] %a %d #[fg=#81a1c1,bg=default]%H:%M "

# Set first line
set -gF status-format[0] '#{status-left}#[align=right]#{status-right}' 


########################################
# SECOND LINE : STATUS WINDOWS BAR
########################################
# For tmux advanced syntax
# see https://man7.org/linux/man-pages/man1/tmux.1.html#NAMES_AND%20TITLES
# For the hack of printing the api-name, whatever the cwd, in the pane label,
# we use ggrep with --perl-regexp as -P
# i.e if the pane_title contains devi, find the string of the pane_current_path between DEV/ and /
# should install GNU grep first, and use it as ggrep : brew install grep

%hidden IS_DEV_FOLDER_RGX=/DEV/
# this regex extracts the string located between /DEV/ and /
# if cwd is /Users/me/DEV/my_project/api/
# it extracts my_project
%hidden FIND_PROJECT_NAME_REGX="(?<=/DEV/).*?(?=/)"
# git diff --quiet 
# returns 0 if no changes
# returns 1 if changes
# we echo that to be use in a tmux conditional 
%hidden HAS_GIT_DIFF_CMD='git diff --quiet; echo $?'

%hidden ACTIVE_BG='#81a1c1'
%hidden ACTIVE_FG='#2e3440'
%hidden HAS_GIT_DIFF_FG='#cf0a9a'


# Usage of rounded Powerline borders
# https://github.com/ryanoasis/powerline-extra-symbols
# These glyphs are included by default in Hack (Nerd font)
# cf https://unicode-table.com/en/
# search for e0b6 and e0b4
# î‚¶ î‚´

setw -g window-status-format '#[fg=#{ACTIVE_FG},bg=default]î‚¶#[bg=#{ACTIVE_FG}]#{?#{mr:#{IS_DEV_FOLDER_RGX},#{pane_current_path}},#{?#(cd #{pane_current_path}; #{HAS_GIT_DIFF_CMD}),#{#[fg=#{HAS_GIT_DIFF_FG}]#I#[fg=#{ACTIVE_BG}] #(echo #{pane_current_path}/ | ggrep -Pio "#{FIND_PROJECT_NAME_REGX}")},#{#[fg=#{ACTIVE_BG}]#I#[fg=#{ACTIVE_BG}] #(echo #{pane_current_path}/ | ggrep -Pio "#{FIND_PROJECT_NAME_REGX}")}},#{#[fg=#{ACTIVE_BG},bg=#{ACTIVE_FG}]#I #{=/-15/â€¦:pane_title}}}#[fg=#{ACTIVE_FG},bg=default]î‚´'

setw -g window-status-current-format '#[fg=#{ACTIVE_BG},bg=default]î‚¶#[bg=#{ACTIVE_BG}]#{?#{mr:#{IS_DEV_FOLDER_RGX},#{pane_current_path}},#{?#(cd #{pane_current_path}; #{HAS_GIT_DIFF_CMD}),#{#[fg=#{HAS_GIT_DIFF_FG},bold]#I#[fg=#{ACTIVE_FG},bold] #(echo #{pane_current_path}/ | ggrep -Pio "#{FIND_PROJECT_NAME_REGX}")},#{#[fg=#{ACTIVE_FG},bold]#I#[fg=#{ACTIVE_FG},bold] #(echo #{pane_current_path}/ | ggrep -Pio "#{FIND_PROJECT_NAME_REGX}")}},#{#[fg=#{ACTIVE_FG},bg=#{ACTIVE_BG},bold]#I #{=/-15/â€¦:pane_title}}}#[fg=#{ACTIVE_BG},bg=default]î‚´'

# Current, same as above without git status
#setw -g window-status-current-format '#[fg=#{ACTIVE_BG},bg=default]î‚¶#[fg=#{ACTIVE_FG},bg=#{ACTIVE_BG},bold]#I #{?#{mr:#{IS_DEV_FOLDER_RGX},#{pane_current_path}},#{#(echo #{pane_current_path}/ | ggrep -Pio "#{FIND_PROJECT_NAME_REGX}")},#{=/-15/â€¦:pane_title}}#[fg=#{ACTIVE_BG},bg=default]î‚´'

setw -g window-status-separator ' '

# backup old and plain version
#setw -g window-status-format '#[fg=#81a1c1,bg=#2c3445] #I: #{=/-15/â€¦:pane_title} '
#setw -g window-status-current-format '#[fg=#2e3440,bg=#81a1c1,bold] #I: #{=/-15/â€¦:pane_title} '


# Fix pane_title (will be set by alacritty)
set -g set-titles on
set -g set-titles-string "#T"

# make window/pane index start with 1
set -g base-index 1
setw -g pane-base-index 1

# Set second line
set -g status-format[1] "#[align=left range=left #[norange default]#[list=on align=#{status-justify}]#[list=left-marker]<#[list=right-marker]>#[list=on]#{W:#[range=window|#{window_index} #{E:window-status-style}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-format}#[pop-default]#[norange default]#{?window_end_flag,,#{window-status-separator}},#[range=window|#{window_index} list=focus #{?#{!=:#{E:window-status-current-style},default},#{E:window-status-current-style},#{E:window-status-style}}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-current-format}#[pop-default]#[norange list=on default]#{?window_end_flag,,#{window-status-separator}}}#[nolist align=right range=right]#[norange default]"

# Print first line
# set -g status on

# Print both lines
set -g status 2
